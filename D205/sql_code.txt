-- This script was generated by a beta version of the ERD tool in pgAdmin 4.
-- Please log an issue at https://redmine.postgresql.org/projects/pgadmin4/issues/new if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE services
(
    customer_id text REFERENCES customer,
    internet_service text,
    phone text,
    multiple text,
    online_security text,
    online_backup text,
    device_protection text,
    tech_support text
);


END;


---

COPY services 
( customer_id,internet_service,phone,multiple,online_security,online_backup,device_protection,tech_support )
FROM 'C:\LabFiles\Services.csv'
DELIMITER ','
CSV HEADER;

---


CREATE VIEW income_view AS
    SELECT c.customer_id, 
		   s.device_protection,
		   c.income,
		   CASE WHEN c.income > 149131 THEN 'Top quintile'
		   		WHEN c.income BETWEEN 89744 AND 149131 THEN 'Fourth quintile'
				WHEN c.income BETWEEN 55000 AND 89744 THEN 'Middle quintile'
				WHEN c.income BETWEEN 28007 AND 55000 THEN 'Second quintile'
				ELSE 'Bottom quintile' END AS income_quintile
      FROM customer AS c
INNER JOIN services AS s
	    ON c.customer_id = s.customer_id
  ORDER BY income DESC;

  SELECT income_quintile, 
	     -- count only those customers that have purchased Device Protection
	     SUM(CASE WHEN device_protection = 'Yes' 
		     	THEN 1 
			    ELSE 0 
    		   END) AS cust_with_dp,
	     count(customer_id) AS total_cust
    FROM income_view 
GROUP BY income_quintile
ORDER BY income_quintile

